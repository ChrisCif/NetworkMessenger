<!DOCTYPE html>
<html lang="en">
<style>

    .sentName
    {

        color: orange;

    }
    .receivedName
    {

        color: cyan;

    }
    .userID
    {

        font-size: 10px;
        color: yellow;

    }
    .mention
    {

        background-color: #2a2a2a;
        color: whitesmoke;

    }

    .col
    {

        border: white dashed 1px;

    }

    #login
    {

        display: block;

    }
    #chat
    {

        display: none;

    }

    #pubOutput
    {

        display: block;

    }
    #otherOutput
    {

        display: none;

    }

</style>
<head>

    <meta charset="UTF-8">
    <title>COPADS Messenger</title>

    <script src="js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">

</head>
<body>

    <!-- Login View -->
    <div id = "login">

        <div class = "col-lg-6 col-lg-offset-3">

            <div class = "row" id = "loginMessages">
                <!-- Append login messages here -->
            </div>

            <div class = "row" id = "loginForm">
                <div class = "card text-white bg-secondary mb-3">
                    <div class = "card-body">

                        <h4>Login</h4>
                        <input id = "nameInput" type = "text">
                        <button id = "nameButton">Login</button>

                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Chat View -->
    <div id = "chat">

        <!-- Header -->
        <div class = "row">

            <h3 id = "channelHead"><!-- Append header here --></h3>

        </div>

        <!-- Full Display -->
        <div class = "row">

            <!-- Channel List -->
            <div class = "col-lg-3">

                <div class = "row">

                    <input id = "newChannelInput" type = "text">
                    <button id = "newChannelSubmit">Create</button>

                </div>

                <div class = "row">
                    <ul id = "chanList">
                        <!--
                        <li value = 0><a href = "#" class = "channelLink">Pub</a></li>
                        <li value = 1><a href = "#" class = "channelLink">Other</a></li>
                        -->
                    </ul>
                </div>

            </div>

            <!-- Display -->
            <div class = "col-lg-6">

                <!-- Output-->
                <div class = "row" id = "output">

                    <!--
                    <!-- Pub Channel
                    <div id = "c0Output">
                        <!-- Append messages here
                    </div>

                    <!-- Other Channel
                    <div id = "c1Output">
                        <!-- Append messages here
                    </div>
                    -->

                </div>

                <!-- Input -->
                <div class = "row" id = "input">

                    <input id = "inputText" type = "text">
                    <button id = "sendButton">Send</button>

                </div>

            </div>

        </div>

    </div>

</body>

<script type="text/javascript">

    var socket;
    var uri = "ws://127.0.0.1:57856/ws";
    var output;
    var text = "test echo";

    // Init
    var me = {
        username: "",
        id: 0
    };

    var currentChannel = 0;
    var channels = [];

    function r_write(s){

        $("#pubOutput").append("<p><span class='receivedName'>Server: </span>" + s + "</p>");

    }

    function connect(){

        socket = new WebSocket(uri);
        socket.onopen = function(e) { r_write("opened " + uri); };
        socket.onclose = function(e) { r_write("closed"); };
        socket.onmessage = function(e) { interpret(e.data); };
        socket.onerror = function(e) { r_write("Error: " + e.data); };

    }

    function interpret(sObj){

        if(sObj.charAt(0) == 'M'){
            // Received a message
            receive_message(sObj.substring(2));
        }
        else if(sObj.charAt(0) == 'C'){
            // Received a new channel
            createChannel(sObj.substring(2));
        }
        else if(sObj.charAt(0) == 'U'){
            // Received user confirmation
            login(sObj.substring(2));
        }

    }

    function send_message(text, channel){

        var prefix = "M:";

        //s_write(text);
        var message = {
            content: text,
            sender: me,
            channel: channel,
            id: 0,   // init
            partID: 1   // TODO
        };

        console.log("Sending message: " + JSON.stringify(message));

        socket.send(prefix + JSON.stringify(message));

    }

    function receive_message(serM){

        console.log("Received message: " + serM);

        var m = JSON.parse(serM);

        channels[m.channel.id].messages.push(m);

        update();

    }

    function write_message(m, c){

        console.log("Writing message: " + m);

        m.content = check_mentions(m.content);  // Check for mentions

        $("#c" + c.id + "Output").append(""+
            "<p><span class='sentName'>" + m.sender.username + "<span class = 'userID'> #" + m.sender.id + "</span>: </span>" + m.content + "</p>"
        );

    }
    function check_mentions(content){

        var text = content;

        var begin_index = 0;
        var next_index = text.indexOf("@");
        while(next_index >= begin_index){

            begin_index = next_index;
            next_index = text.substring(begin_index + 1).indexOf("@") + begin_index;
            var end = next_index;
            if(next_index < begin_index){
                end = text.length;
            }

            var name_index = text.substring(begin_index, end).indexOf(username);
            if(name_index == 1){

                var m_final = begin_index + username.length + 1;
                var before_text = text.substring(0, begin_index);
                var within_text = text.substring(begin_index, m_final);
                var after_text = text.substring(m_final);

                text = before_text + "<span class = 'mention'>" + within_text + "</span>" + after_text;

            }

        }

        return text;

    }

    function submit_channel(chanName){

        var prefix = "C:";

        var channel = {
            id: 0,  // Init
            name: chanName,
            creator: me,
            participants: [me], // TODO: Will these convert to lists ok?
            messages: []
        };

        var sObj = prefix + JSON.stringify(channel);

        console.log("Submitting channel: " + sObj);

        socket.send(sObj);

    }
    function createChannel(chanConfirmation){

        console.log("Creating channel: " + chanConfirmation);

        var channel = JSON.parse(chanConfirmation);
        channels.push(channel);

        $("#output").append("<div id = 'c" + channel.id + "Output'></div>");

        update();

    }

    function register_user(username){

        var prefix = "U:";

        var user = {    // init
            username: username,
            id: 0
        };

        var sObj = prefix + JSON.stringify(user);
        socket.send(sObj);

    }

    function login(newUser){

        me = JSON.parse(newUser);

        $("#login").css("display", "none");
        $("#chat").css("display", "block");

    }

    function update(){

        updateChannelList();
        echoMessages();
        updateChannelDisplay();

    }
    function updateChannelList(){

        $("#chanList").html("");

        for(var x = 0; x < channels.length; x++){

            var channel = channels[x];

            $("#chanList").append("<li value = '" + channel.id + "'><a href = '#' class = 'channelLink'>" + channel.name + "</a></li>");

        }

    }
    function echoMessages(){

        console.log("Echoing messages");

        for(var c = 0; c < channels.length; c++){

            var channel = channels[c];
            $("#c" + channel.id + "Output").html("");

            for (var m = 0; m < channel.messages.length; m++){

                write_message(channel.messages[m], channel);

            }

        }

    }
    function updateChannelDisplay() {

        var len = $("#output").children().length;


        for (var x = 0; x < len; x++) {

            $("#c" + x + "Output").css("display", "none");

        }

        $("#c" + currentChannel.id + "Output").css("display", "block");
        $("#channelHead").html(currentChannel.name);

    }

    $(document).ready(function(){

        connect();
        update();

        //Login
        $("#nameButton").click(function(){

            var name = $("#nameInput").val();

            if(name != ""){

                register_user(name);

            }
            else{

                $("#loginMessages").html(""+
                        "<div class = 'alert alert-dismissible alert danger'>" +
                        "   <button type=\'button\' class=\'close\' data-dismiss=\'alert\'>&times;</button>"+
                        "   <p>No ghosts allowed (ghouls are okay though)</p>"+
                        "</div>"
                );
            }

            $("#nameInput").val("");

        });

        // Send Messages
        $("#sendButton").click(function(){

            var message = $("#inputText").val();
            if(message != ""){

                $("#inputText").val("");
                send_message(message, currentChannel);

            }

        });

        // Switch Channels
        // Listener for dynamically added links
        $("body").on("click", ".channelLink", function(){

            currentChannel = channels[$(this).parent().attr("value")];
            update();

        });

        // Create a new channel
        $("#newChannelSubmit").click(function(){

            var cName = $("#newChannelInput").val();
            $("#newChannelInput").val("");
            if(cName != ""){

                submit_channel(cName);

            }

        });

    });

</script>

</html>