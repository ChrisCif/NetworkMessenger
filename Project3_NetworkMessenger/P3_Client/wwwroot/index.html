<!DOCTYPE html>
<html lang="en">
<style>

    .sentName
    {

        color: orange;

    }
    .receivedName
    {

        color: cyan;

    }
    .userID
    {

        font-size: 10px;
        color: yellow;

    }
    .mention
    {

        background-color: #2a2a2a;
        color: whitesmoke;

    }

    .col
    {

        border: white dashed 1px;

    }

    #login
    {

        display: block;

    }
    #chat
    {

        display: none;

    }

    #pubOutput
    {

        display: block;

    }
    #otherOutput
    {

        display: none;

    }

</style>
<head>

    <meta charset="UTF-8">
    <title>COPADS Messenger</title>

    <script src="js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css">

</head>
<body>

    <!-- Login View -->
    <div id = "login">

        <div class = "col-lg-6 col-lg-offset-3">

            <div class = "row" id = "loginMessages">
                <!-- Append login messages here -->
            </div>

            <div class = "row" id = "loginForm">
                <div class = "card text-white bg-secondary mb-3">
                    <div class = "card-body">

                        <h4>Login</h4>
                        <input id = "nameInput" type = "text">
                        <button id = "nameButton">Login</button>

                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Chat View -->
    <div id = "chat">

        <!-- Header -->
        <div class = "row">

            <h3 id = "channelHead"><!-- Append header here --></h3>

        </div>

        <!-- Full Display -->
        <div class = "row">

            <!-- Channel List -->
            <div class = "col-lg-3">

                <div class = "row">

                    <input id = "newChannelInput" type = "text">
                    <button id = "newChanelSubmit">Create</button>

                </div>

                <div class = "row" id = "chanList">
                    <p><a href = "#" id = "pubLink">Pub</a></p>
                    <p><a href = "#" id = "otherLink">Other</a></p>
                </div>

            </div>

            <!-- Display -->
            <div class = "col-lg-6">

                <!-- Output-->
                <div class = "row" id = "output">

                    <!-- Pub Channel -->
                    <div id = "cpubOutput">
                        <!-- Append messages here -->
                    </div>

                    <!-- Other Channel -->
                    <div id = "cotherOutput">
                        <!-- Append messages here -->
                    </div>

                </div>

                <!-- Input -->
                <div class = "row" id = "input">

                    <input id = "inputText" type = "text">
                    <button id = "sendButton">Send</button>

                </div>

            </div>

        </div>

    </div>

</body>

<script type="text/javascript">

    var socket;
    var uri = "ws://127.0.0.1:57856/ws";
    var output;
    var text = "test echo";

    // Init
    var me = {
        username: "",
        id: 0
    };

    var currentChannel = "pub";

    var messages = [];

    /*
    function s_write(s){

        console.log("Received: " + s);
        var message = JSON.parse(s);

        //var channel = message.channel + "Output";

        //$("#output").empty();
        $("#" + message.channel + "Output").append("<p><span class='sentName'>" + message.sender.username + "<span id = 'userID'> #" + message.sender.id + "</span>: </span>" + message.content + "</p>");

    }
    */
    function r_write(s){

        $("#pubOutput").append("<p><span class='receivedName'>Server: </span>" + s + "</p>");

    }

    function connect(){

        socket = new WebSocket(uri);
        socket.onopen = function(e) { r_write("opened " + uri); };
        socket.onclose = function(e) { r_write("closed"); };
        socket.onmessage = function(e) { interpret(e.data); };
        socket.onerror = function(e) { r_write("Error: " + e.data); };

    }

    function interpret(sObj){

        if(sObj.charAt(0) == 'M'){
            // Received a message
            receive_message(sObj.substring(2));
        }
        else if(sObj.charAt(0) == 'C'){
            // Received a new channel
            createChannel(sObj.substring(2));
        }

    }

    function receive_message(serM){

        //console.log("Received: " + serM);

        var m = JSON.parse(serM);

        messages.push(m);
        write_message(m);

    }

    function write_message(m){

        m.content = check_mentions(m.content);  // Check for mentions

        $("#c" + m.channel + "Output").append(""+
            "<p><span class='sentName'>" + m.sender.username + "<span class = 'userID'> #" + m.sender.id + "</span>: </span>" + m.content + "</p>"
        );

    }

    function check_mentions(content){

        var text = content;

        var begin_index = 0;
        var next_index = text.indexOf("@");
        while(next_index >= begin_index){

            begin_index = next_index;
            next_index = text.substring(begin_index + 1).indexOf("@") + begin_index;
            var end = next_index;
            if(next_index < begin_index){
                end = text.length;
            }

            var name_index = text.substring(begin_index, end).indexOf(username);
            if(name_index == 1){

                var m_final = begin_index + username.length + 1;
                var before_text = text.substring(0, begin_index);
                var within_text = text.substring(begin_index, m_final);
                var after_text = text.substring(m_final);

                text = before_text + "<span class = 'mention'>" + within_text + "</span>" + after_text;

            }

        }

        return text;

    }

    function send_message(text, channel){

        var prefix = "M:";

        //s_write(text);
        var message = {
            content: text,
            sender: me,
            channel: channel
        };
        socket.send(prefix + JSON.stringify(message));

        //console.log("Attempting to send: " + JSON.stringify(message));

    }

    function updateChannelDisplay(){

        // TODO: Generic way of updating display

        if(currentChannel == "pub"){

            $("#cpubOutput").css("display", "block");
            $("#cotherOutput").css("display", "none");

            $("#channelHead").html("Pub");

        }
        else if(currentChannel == "other"){

            $("#cpubOutput").css("display", "none");
            $("#cotherOutput").css("display", "block");

            $("#channelHead").html("Other");

        }

    }

    function submit_channel(chanName){

        var prefix = "C:";

        var channel = {
            id: 0,  // Init
            name: chanName,
            creator: me
        };

        socket.send(prefix + JSON.stringify(channel));

    }
    function createChannel(chanConfirmation){

        var channel = JSON.parse(chanConfirmation);

        // TODO: Assign channel ID to link

        $("#chanList").append("<p><a href = '#' id = '" + channel.name +"Link'>Pub</a></p>");

        $("#output").append("<div id = 'c" + channel.name + "Output'></div>");

    }

    function login(){

        $("#login").css("display", "none");
        $("#chat").css("display", "block");

    }

    $(document).ready(function(){

        connect();

        updateChannelDisplay();

        //Login
        $("#nameButton").click(function(){

            var name = $("#nameInput").val();

            if(name != ""){

                //username = name;
                me.username = name;
                login();

            }
            else{

                $("#loginMessages").html(""+
                        "<div class = 'alert alert-dismissible alert danger'>" +
                        "   <button type=\'button\' class=\'close\' data-dismiss=\'alert\'>&times;</button>"+
                        "   <p>No ghosts allowed (ghouls are okay though)</p>"+
                        "</div>"
                );
            }

            $("#nameInput").val("");

        });

        // Send Messages
        $("#sendButton").click(function(){

            var message = $("#inputText").val();
            if(message != ""){

                $("#inputText").val("");
                send_message(message, currentChannel);

            }

        });

        // Switch Channels
        $("#pubLink").click(function(){

            currentChannel = "pub";
            updateChannelDisplay();

        });
        $("#otherLink").click(function(){

            currentChannel = "other";
            updateChannelDisplay();

        });

        // Create a new channel
        $("#newChannelSubmit").click(function(){

            var cName = $("newChannelInput").val();
            if(cName != ""){

                submit_channel(cName);

            }

        });

    });

</script>

</html>